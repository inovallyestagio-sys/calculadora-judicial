<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Novo Cálculo - Sistema de Calculadora Jurídica</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap"
        rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    
    <style>
        .modal { background-color: rgba(0, 0, 0, 0.5); transition: opacity 0.3s ease-in-out; }
        .modal-content { transition: transform 0.3s ease-in-out; transform: translateY(-50px); max-height: 90vh; overflow-y: auto; }
        .modal.open .modal-content { transform: translateY(0); }
        .user-dropdown { display: none; }
        .user-dropdown.show { display: block; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        @media print {
            body * { visibility: hidden; }
            #requerentes-tables-container, #requerentes-tables-container * { visibility: visible; }
            #requerentes-tables-container { position: absolute; left: 0; top: 0; width: 100%; padding: 1cm; font-size: 10pt; }
            .no-print { display: none !important; }
            .calculation-table { width: 100% !important; table-layout: fixed; border-collapse: collapse; font-size: 8pt; }
            .calculation-table th, .calculation-table td { border: 1px solid #ccc; padding: 4px 6px; word-wrap: break-word; text-align: left; }
            .calculation-table th { background-color: #f2f2f2 !important; color: #000 !important; -webkit-print-color-adjust: exact; color-adjust: exact; }
            .calculation-table td:nth-child(n+5) { text-align: right; }
        }
    </style>
</head>

<body class="bg-gray-50 font-sans flex flex-col h-screen overflow-hidden">
    <header class="bg-gradient-to-r from-[#143968] to-[#14d2aa] text-white shadow-lg z-50 h-16 flex-shrink-0 no-print">
        <div class="flex items-center justify-between px-4 py-1">
             <a href="home.html" class="sidebar-item flex items-center space-x-3 px-3 py-3 hover:bg-white hover:bg-opacity-20 transition-all rounded-lg"><i class="fas fa-home text-lg"></i></a>
            <div class="logo-inovally px-6"><a href="#" id="logo-produto"><img src="assets/Group 338.svg" alt="logo-inovally" class="h-12 w-28"></a></div>
            <div class="relative ml-auto">
                <button id="userDropdownBtn" class="flex items-center space-x-3 px-3 py-2 rounded-lg transition-colors">
                    <div class="text-right hidden sm:block"><p class="text-sm font-medium">Olá, Amanda</p><p class="text-xs opacity-80">Operador</p></div>
                    <div class="w-10 h-10 bg-primary-teal rounded-full flex items-center justify-center"><i class="fas fa-user text-white"></i></div>
                    <i class="fas fa-chevron-down text-xs hidden sm:block"></i>
                </button>
                <div id="userDropdown" class="user-dropdown absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border z-50 hidden">
                    <a href="#" class="block px-4 py-3 text-gray-700 hover:bg-gray-50 border-b"><i class="fas fa-cog mr-2"></i>Configurar Conta</a>
                    <a href="#" class="block px-4 py-3 text-gray-700 hover:bg-gray-50"><i class="fas fa-sign-out-alt mr-2"></i>Sair</a>
                </div>
            </div>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        <aside id="sidebar" class="w-16 bg-gradient-to-b from-[#143968] to-[#14d2aa] text-white shadow-lg z-40 no-print">
            <nav class="flex-1 mt-4"><ul class="space-y-4">
                <li><a href="index.html" class="sidebar-item flex flex-col items-center px-4 py-3 bg-[#14d2aa] bg-opacity-100"><i class="fas fa-calculator text-lg mb-1"></i><span class="text-[10px] text-center">Novo Cálculo</span></a></li>
                <li><a href="my-calculations.html" class="sidebar-item flex flex-col items-center px-4 py-3 hover:bg-white hover:bg-opacity-20 transition-all"><i class="fas fa-folder text-lg mb-1"></i><span class="text-[10px] text-center">Meus Cálculos</span></a></li>
            </ul></nav>
        </aside>

        <main id="main-content" class="flex-1 p-6 overflow-y-auto">
            <div class="max-w-7xl mx-auto">
                <div class="mb-6"><h2 class="text-3xl font-bold text-primary-blue mb-2">Realizar Novo Cálculo</h2><p class="text-gray-600">Sistema de Calculadora Jurídica</p></div>
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <div class="mb-8">
                        <h3 class="text-xl font-semibold text-primary-blue mb-4">Tipo de Cálculo Jurídico</h3>
                        <div class="relative">
                            <select id="calculationType" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-teal focus:border-transparent appearance-none bg-white pr-8 cursor-pointer">
                                <option value="" selected disabled>Selecione um tipo de cálculo</option>
                                <option value="trabalhista">Enquadramento Trabalhista</option>
                                <option value="trabalhista-full">Trabalhista</option>
                                <option value="patrimonio">Patrimônio</option>
                                <option value="fiscal">Fiscal</option>
                                <option value="administrativo">Administrativo</option>
                            </select>
                            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700"><svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z" /></svg></div>
                        </div>
                    </div>
                    <div id="formFields" class="hidden">
                        <div class="mb-8">
                            <h3 class="text-xl font-semibold text-primary-blue mb-4">1. Upload e Extração de Dados</h3>
                            <div id="uploadArea" class="upload-area p-8 rounded-lg text-center cursor-pointer border-2 border-dashed border-gray-300 hover:border-primary-teal transition-colors">
                                <i class="fas fa-cloud-upload-alt text-4xl text-primary-teal mb-4"></i><p class="text-gray-600 mb-2">Clique para simular a extração de dados do PDF da Sentença</p><p class="text-sm text-gray-400">Isso preencherá os campos abaixo</p>
                                <input type="file" id="fileInput" class="hidden" accept=".pdf">
                            </div>
                        </div>
                        <div class="mb-8">
                            <h3 class="text-xl font-semibold text-primary-blue mb-4">2. Dados do Processo</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div><label class="block text-sm font-medium text-gray-700 mb-2">Número do Processo</label><input type="text" id="processNumber" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100" placeholder="0000000-00.0000.0.00.0000" readonly></div>
                                <div><label class="block text-sm font-medium text-gray-700 mb-2">Data de Citação</label><input type="date" id="dataCitacao" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100" readonly></div>
                                <div class="col-span-1 md:col-span-2"><label class="block text-sm font-medium text-gray-700 mb-2">Parte Requerente(s)</label><input type="text" id="requerentesInput" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100" placeholder="Nome(s) separado(s) por vírgula" readonly></div>
                                <div class="col-span-1 md:col-span-2"><label class="block text-sm font-medium text-gray-700 mb-2">Valor Executado (Cumprimento de Sentença)</label><input type="text" id="valorExecutadoInput" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100" placeholder="R$ 0,00" readonly></div>
                            </div>
                        </div>
                        <div class="mb-8">
                            <h3 class="text-xl font-semibold text-primary-blue mb-4">3. Configuração de Parâmetros</h3>
                            <button type="button" onclick="openModal('parametersModal')" class="bg-primary-teal hover:bg-secondary-teal text-white px-6 py-3 rounded-lg font-semibold transition-colors"><i class="fas fa-cogs mr-2"></i>Abrir Configurações</button>
                        </div>
                        <div class="flex justify-start mb-8"><button id="calculateBtn" class="bg-secondary-blue hover:bg-primary-blue text-white px-8 py-3 rounded-lg font-semibold transition-colors"><i class="fas fa-calculator mr-2"></i>Calcular Valor</button></div>
                        <hr class="my-8">
                        <div id="requerentes-tables-container" class="space-y-12"></div>
                        <div class="summary-container mt-8 grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="summary-box bg-white p-6 rounded-lg shadow-lg border border-gray-200"><p class="text-sm text-gray-500 mb-2">VALOR EXECUTADO</p><p class="text-2xl font-bold text-primary-blue" id="valorExecutadoSummary">R$ 0,00</p></div>
                            <div class="summary-box bg-white p-6 rounded-lg shadow-lg border border-gray-200"><p class="text-sm text-gray-500 mb-2">VALOR ATUALIZADO (TOTAL)</p><p class="text-2xl font-bold text-primary-blue" id="valorAtualizadoSummary">R$ 0,00</p></div>
                            <div class="summary-box bg-white p-6 rounded-lg shadow-lg border border-gray-200"><p class="text-sm text-gray-500 mb-2">PROVEITO ECONÔMICO</p><p class="text-2xl font-bold text-primary-blue" id="proveitoEconomicoSummary">R$ 0,00</p></div>
                        </div>
                        <div class="flex flex-wrap gap-4 justify-center mt-8 no-print">
                            <button onclick="saveCalculation()" class="bg-secondary-blue hover:bg-primary-blue text-white px-8 py-3 rounded-lg font-semibold transition-colors"><i class="fas fa-save mr-2"></i>Salvar Cálculo</button>
                            <button onclick="generateReport()" class="bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-lg font-semibold transition-colors"><i class="fas fa-file-pdf mr-2"></i>Gerar Relatório</button>
                            <button onclick="clearForm()" class="bg-gray-500 hover:bg-gray-600 text-white px-8 py-3 rounded-lg font-semibold transition-colors"><i class="fas fa-eraser mr-2"></i>Limpar Formulário</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <div id="parametersModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 modal hidden">
             <div class="bg-white rounded-lg shadow-xl p-8 max-w-2xl w-full modal-content">
                <div class="flex justify-between items-center pb-3 border-b mb-4"><h3 class="text-2xl font-semibold text-primary-blue">Configurar Parâmetros de Cálculo</h3><button onclick="closeModal('parametersModal')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button></div>
                <div class="space-y-6"><p class="text-gray-700">Selecione um requerente para configurar os parâmetros específicos do cálculo.</p><div id="requerentes-params-container" class="space-y-4"><p class="text-gray-500">Nenhum requerente extraído.</p></div></div>
                <div class="mt-8 flex justify-end space-x-4"><button onclick="closeModal('parametersModal')" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold px-6 py-3 rounded-lg">Fechar</button></div>
            </div>
        </div>

        <div id="requerenteParamModal" class="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black bg-opacity-50 modal hidden">
            <div class="bg-white rounded-lg shadow-xl p-8 max-w-6xl w-full modal-content">
                <div class="flex justify-between items-center pb-3 border-b mb-4"><h3 class="text-2xl font-semibold text-primary-blue">Parâmetros para <span id="requerenteNomeTitle"></span></h3><button onclick="closeModal('requerenteParamModal')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button></div>
                <div class="space-y-6">
                    <div>
                        <h4 class="text-lg font-semibold text-gray-700 mb-4">Eventos a Calcular</h4>
                        <div id="eventos-container" class="flex flex-wrap gap-4">
                            <label class="flex items-center space-x-2"><input type="checkbox" name="eventoCalc" value="Salário Base" class="rounded text-primary-teal" checked><span>Salário Base</span></label>
                            <label class="flex items-center space-x-2"><input type="checkbox" name="eventoCalc" value="13º Salário" class="rounded text-primary-teal"><span>13º Salário</span></label>
                            <label class="flex items-center space-x-2"><input type="checkbox" name="eventoCalc" value="Férias" class="rounded text-primary-teal"><span>Férias</span></label>
                            <label class="flex items-center space-x-2"><input type="checkbox" name="eventoCalc" value="FGTS" class="rounded text-primary-teal"><span>FGTS</span></label>
                            <label class="flex items-center space-x-2"><input type="checkbox" name="eventoCalc" value="ATS" class="rounded text-primary-teal"><span>ATS</span></label>
                        </div>
                    </div>
                    <hr class="my-6">
                    <div>
                        <h4 class="text-lg font-semibold text-gray-700 mb-4">Período Geral e Consulta Turmalina (Simulação)</h4>
                        <div id="turmalina-container" class="grid grid-cols-1 md:grid-cols-5 gap-6 items-end">
                             <div><label class="block text-sm font-medium text-gray-700 mb-2">Início do Período</label><input type="text" id="turmalina-inicio" name="turmalina_inicio" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="mm/aaaa" maxlength="7" oninput="applyDateMask(event)"></div>
                             <div><label class="block text-sm font-medium text-gray-700 mb-2">Fim do Período</label><input type="text" id="turmalina-fim" name="turmalina_fim" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="mm/aaaa" maxlength="7" oninput="applyDateMask(event)"></div>
                             <div><label class="block text-sm font-medium text-gray-700 mb-2">Cargo</label><input type="text" id="cargoRequerente" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100" placeholder="Aguardando..." readonly></div>
                             <div><label class="block text-sm font-medium text-gray-700 mb-2">Valor Recebido</label><input type="text" id="valorRecebidoTurmalina" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100" placeholder="R$ 0,00" readonly></div>
                             <div><button onclick="consultarTurmalina(this)" class="bg-primary-teal hover:bg-secondary-teal text-white px-4 py-3 rounded-lg font-semibold transition-colors w-full"><i class="fas fa-database mr-2"></i>Consultar</button></div>
                        </div>
                    </div>
                    <hr class="my-6">
                    <div>
                        <h4 class="text-lg font-semibold text-gray-700 mb-4">Sub-Períodos de Cálculo e Índices</h4>
                        <div id="periodos-container" class="space-y-4"></div>
                         <button onclick="addPeriodField()" class="mt-4 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-semibold"><i class="fas fa-plus mr-2"></i>Adicionar Sub-Período</button>
                    </div>
                </div>
                <div class="mt-8 flex justify-end space-x-4 border-t pt-6">
                    <button onclick="closeModal('requerenteParamModal')" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold px-6 py-3 rounded-lg">Cancelar</button>
                    <button onclick="saveParametersForRequerente()" class="bg-primary-blue hover:bg-secondary-blue text-white font-semibold px-6 py-3 rounded-lg">Salvar Parâmetros</button>
                </div>
            </div>
        </div>
        
        <template id="periodo-template">
             <div class="periodo-item grid grid-cols-1 md:grid-cols-6 gap-x-4 gap-y-2 items-end p-4 border rounded-lg bg-gray-50">
                <div class="md:col-span-1"><label class="block text-sm font-medium text-gray-700">Início</label><input type="text" name="periodo_inicio" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="mm/aaaa" maxlength="7" oninput="applyDateMask(event)" onchange="updateTaxRate(event)"></div>
                <div class="md:col-span-1"><label class="block text-sm font-medium text-gray-700">Fim</label><input type="text" name="periodo_fim" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="mm/aaaa" maxlength="7" oninput="applyDateMask(event)" onchange="updateTaxRate(event)"></div>
                <div class="md:col-span-1"><label class="block text-sm font-medium text-gray-700">Nível/Classe</label><select name="periodo_nivel" class="w-full px-3 py-2 border border-gray-300 rounded-lg"></select></div>
                <div class="md:col-span-1"><label class="block text-sm font-medium text-gray-700">Índice</label><select name="periodo_indice" class="w-full px-3 py-2 border border-gray-300 rounded-lg" onchange="updateTaxRate(event)"></select></div>
                <div class="md:col-span-1"><label class="block text-sm font-medium text-gray-700">Taxa Juros</label><input type="text" name="periodo_taxa" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100" placeholder="-" readonly></div>
                <div class="md:col-span-1"><button onclick="this.closest('.periodo-item').remove()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg w-full"><i class="fas fa-trash"></i></button></div>
            </div>
        </template>
        
        <script>
            // ====================================================================
            // BANCO DE DADOS, MOCKS E VARIÁVEIS GLOBAIS
            // ====================================================================
            const mockProcesso = { processNumber: '0012345-78.2024.8.11.0001', requerentes: ["Aroldo Pascoal", "Maria da Anunciação", "Nilda de França"], valorExecutado: 185450.75, dataCitacao: '2023-10-20' };
            const mockSalarioTabela = { 'Lei 2.361/2001': { 'Nível 1-A': 3200.00, 'Nível 1-B': 3350.00, 'Nível 1-C': 3500.00, 'Nível 2-A': 3800.00, 'Nível 2-B': 3950.00, 'Nível 2-C': 4100.00, 'Nível 3-A': 4500.00, 'Nível 3-B': 4650.00, 'Nível 3-C': 4800.00, }, 'Lei 4.588/2005': { 'Nível 1-A': 3500.00, 'Nível 1-B': 3650.00, 'Nível 1-C': 3800.00, 'Nível 2-A': 4100.00, 'Nível 2-B': 4250.00, 'Nível 2-C': 4400.00, 'Nível 3-A': 4800.00, 'Nível 3-B': 4950.00, 'Nível 3-C': 5100.00, } };
            const mockIndices = { 'IPCA-E': { juros: 0.005, correcao: 0.003, nome: 'IPCA-E' }, 'SELIC': { juros: 0.000, correcao: 0.009, nome: 'SELIC' } };
            let requerenteConfigStorage = {};

            // ====================================================================
            // INICIALIZAÇÃO E EVENTOS GLOBAIS
            // ====================================================================
            document.addEventListener('DOMContentLoaded', () => {
                const userDropdownBtn = document.getElementById('userDropdownBtn'); const userDropdown = document.getElementById('userDropdown');
                const calculationTypeSelect = document.getElementById('calculationType'); const formFields = document.getElementById('formFields');
                const uploadArea = document.getElementById('uploadArea'); const calculateBtn = document.getElementById('calculateBtn');
                userDropdownBtn.addEventListener('click', () => userDropdown.classList.toggle('hidden'));
                document.addEventListener('click', (e) => { if (!userDropdownBtn.contains(e.target) && !userDropdown.contains(e.target)) userDropdown.classList.add('hidden'); });
                calculationTypeSelect.addEventListener('change', (e) => formFields.classList.toggle('hidden', e.target.value !== 'trabalhista'));
                uploadArea.addEventListener('click', simularExtracaoDocumento);
                calculateBtn.addEventListener('click', calcularValores);
            });
            
            // ====================================================================
            // FUNÇÕES PRINCIPAIS E DE UI
            // ====================================================================
            function simularExtracaoDocumento() {
                alert(`Simulando extração de dados...`);
                document.getElementById('processNumber').value = mockProcesso.processNumber;
                document.getElementById('dataCitacao').value = mockProcesso.dataCitacao;
                document.getElementById('requerentesInput').value = mockProcesso.requerentes.join(', ');
                document.getElementById('valorExecutadoInput').value = formatToCurrency(mockProcesso.valorExecutado);
                requerenteConfigStorage = {};
                mockProcesso.requerentes.forEach(nome => {
                    requerenteConfigStorage[nome] = { isConfigured: false, eventos: [], periodos: [], dadosTurmalina: {}, periodoGeral: {} };
                });
            }
            window.openModal = (id) => { document.getElementById(id).classList.remove('hidden'); document.getElementById(id).classList.add('open'); document.body.classList.add('overflow-hidden'); if (id === 'parametersModal') populateRequerentesParams(); };
            window.closeModal = (id) => { document.getElementById(id).classList.add('hidden'); document.getElementById(id).classList.remove('open'); if (!document.querySelector('.modal:not(.hidden)')) document.body.classList.remove('overflow-hidden'); };
            
            function populateRequerentesParams() {
                const container = document.getElementById('requerentes-params-container');
                const requerentes = document.getElementById('requerentesInput').value.split(',').map(n => n.trim()).filter(Boolean);
                container.innerHTML = '';
                if(requerentes.length === 0) { container.innerHTML = '<p class="text-gray-500">Simule a extração de dados primeiro.</p>'; return; }
                
                requerentes.forEach(nome => {
                    const config = requerenteConfigStorage[nome];
                    const isConfigured = config && config.isConfigured;
                    const icon = isConfigured ? '✅' : '⚫';
                    const colorClasses = isConfigured ? 'bg-green-100 hover:bg-green-200 text-green-800 font-semibold' : 'bg-gray-100 hover:bg-gray-200';
                    
                    const button = document.createElement('button');
                    button.innerHTML = `<span class="mr-3">${icon}</span> ${nome}`;
                    button.className = `w-full text-left px-4 py-3 rounded-lg font-medium transition-colors flex items-center ${colorClasses}`;
                    button.onclick = () => openRequerenteParamModal(nome);
                    container.appendChild(button);
                });
            }

            window.openRequerenteParamModal = function (requerenteNome) {
                const modal = document.getElementById('requerenteParamModal');
                modal.dataset.currentRequerente = requerenteNome;
                document.getElementById('requerenteNomeTitle').textContent = requerenteNome;
                const config = requerenteConfigStorage[requerenteNome] || { isConfigured: false, eventos: [], periodos: [], dadosTurmalina: {}, periodoGeral: {} };
                
                modal.querySelectorAll('#eventos-container input[type="checkbox"]').forEach(cb => cb.checked = config.eventos.includes(cb.value));
                modal.querySelector('#turmalina-inicio').value = formatToMMYYYY(config.periodoGeral.inicio);
                modal.querySelector('#turmalina-fim').value = formatToMMYYYY(config.periodoGeral.fim);
                modal.querySelector('#cargoRequerente').value = config.dadosTurmalina.cargo || '';
                modal.querySelector('#valorRecebidoTurmalina').value = config.dadosTurmalina.valorTotal ? formatToCurrency(config.dadosTurmalina.valorTotal) : '';
                
                const periodosContainer = document.getElementById('periodos-container');
                periodosContainer.innerHTML = '';
                if (config.periodos && config.periodos.length > 0) {
                    config.periodos.forEach(p => addPeriodField(p));
                } else {
                    addPeriodField();
                }

                openModal('requerenteParamModal');
            };

            window.consultarTurmalina = function(button) {
                 const modal = button.closest('#requerenteParamModal');
                 const requerenteNome = modal.dataset.currentRequerente;
                 const inicio = modal.querySelector('#turmalina-inicio').value;
                 const fim = modal.querySelector('#turmalina-fim').value;

                 if (!inicio || !fim || inicio.length < 7 || fim.length < 7) {
                    alert("Por favor, preencha o Período Geral (Início e Fim) antes de consultar.");
                    return;
                 }

                 alert(`Consultando Turmalina para ${requerenteNome} no período de ${inicio} a ${fim}...`);
                 const randomCargo = Math.random() > 0.5 ? 'Professor Nível Superior 25H' : 'Técnico Administrativo Pleno';
                 const randomValor = Math.random() * (120000 - 80000) + 80000;
                 const randomMatricula = Math.floor(1000 + Math.random() * 9000);
                 
                 modal.querySelector('#cargoRequerente').value = randomCargo;
                 modal.querySelector('#valorRecebidoTurmalina').value = formatToCurrency(randomValor);
                 
                 if(requerenteConfigStorage[requerenteNome]) {
                    requerenteConfigStorage[requerenteNome].dadosTurmalina.matricula = randomMatricula;
                    requerenteConfigStorage[requerenteNome].dadosTurmalina.valorTotal = randomValor;
                 }
            }
            
            window.addPeriodField = function(data = {}) {
                const template = document.getElementById('periodo-template');
                const clone = template.content.firstElementChild.cloneNode(true);
                const nivelSelect = clone.querySelector('select[name="periodo_nivel"]');
                const indiceSelect = clone.querySelector('select[name="periodo_indice"]');
                
                let todosOsNiveis = new Set();
                Object.values(mockSalarioTabela).forEach(tabela => Object.keys(tabela).forEach(nivel => todosOsNiveis.add(nivel)));
                todosOsNiveis.forEach(nivel => nivelSelect.add(new Option(nivel, nivel)));
                
                indiceSelect.add(new Option("Selecione...", "", true, true));
                indiceSelect.querySelector('option').disabled = true;
                Object.keys(mockIndices).forEach(nome => indiceSelect.add(new Option(nome, nome)));
                
                const periodosContainer = document.getElementById('periodos-container');
                const allPeriods = periodosContainer.querySelectorAll('.periodo-item');

                let initialStartDate = '';
                if (allPeriods.length === 0) {
                    initialStartDate = document.getElementById('turmalina-inicio').value;
                } else {
                    const lastPeriodFim = allPeriods[allPeriods.length - 1].querySelector('input[name="periodo_fim"]').value;
                    initialStartDate = getNextMonth(lastPeriodFim);
                }
                
                clone.querySelector('input[name="periodo_inicio"]').value = data.inicio ? formatToMMYYYY(data.inicio) : initialStartDate;
                clone.querySelector('input[name="periodo_fim"]').value = formatToMMYYYY(data.fim);
                if(data.nivel) nivelSelect.value = data.nivel;
                if(data.indice) { indiceSelect.value = data.indice; updateTaxRate({ target: indiceSelect }); }

                periodosContainer.appendChild(clone);
            }
            
            // ====================================================================
            // LÓGICA DE CÁLCULO E GERAÇÃO DE RELATÓRIO (Inalterada)
            // ====================================================================
            function calcularValores() { const container = document.getElementById('requerentes-tables-container'); container.innerHTML = ''; let totalGeralAtualizado = 0; const requerentes = Object.keys(requerenteConfigStorage); if(requerentes.length === 0) return alert('Simule a extração de dados primeiro.'); requerentes.forEach(nome => { const config = requerenteConfigStorage[nome]; if (!config.isConfigured){ console.warn(`Cálculo para ${nome} pulado: Parâmetros não configurados/salvos.`); return; } if (config.periodos.length === 0 || config.eventos.length === 0) return; let tableData = createTableForRequerente(nome, config); container.innerHTML += tableData.html; totalGeralAtualizado += tableData.totalRequerenteAtualizado; }); const valorExecutado = parseCurrency(document.getElementById('valorExecutadoInput').value); document.getElementById('valorExecutadoSummary').textContent = formatToCurrency(valorExecutado); document.getElementById('valorAtualizadoSummary').textContent = formatToCurrency(totalGeralAtualizado); document.getElementById('proveitoEconomicoSummary').textContent = formatToCurrency(totalGeralAtualizado - valorExecutado); }
            function createTableForRequerente(nome, config) { let bodyHTML = ''; let totais = { devido: 0, recebido: 0, diferenca: 0, atualizado: 0 }; const numMesesTotal = config.periodos.reduce((acc, p) => acc + countMonths(p.inicio, p.fim), 0); const valorRecebidoMensal = numMesesTotal > 0 ? (config.dadosTurmalina.valorTotal || 0) / numMesesTotal : 0; config.periodos.forEach(periodo => { let currentDate = new Date(periodo.inicio + '-02T00:00:00Z'); const endDate = new Date(periodo.fim + '-02T00:00:00Z'); while (currentDate <= endDate) { const mesRef = currentDate.toLocaleDateString('pt-BR', { month: '2-digit', year: 'numeric', timeZone: 'UTC' }); const leiAplicada = getLeiParaNivel(periodo.nivel); const valorDevido = mockSalarioTabela[leiAplicada]?.[periodo.nivel] || 0; const indiceInfo = mockIndices[periodo.indice]; config.eventos.forEach(evento => { let devidoEvento = (evento === '13º Salário' && currentDate.getUTCMonth() === 11) ? valorDevido : (evento === 'Salário Base' ? valorDevido : 0); let recebidoEvento = (evento === '13º Salário' && currentDate.getUTCMonth() === 11) ? valorRecebidoMensal : (evento === 'Salário Base' ? valorRecebidoMensal * (0.85 + Math.random() * 0.1) : 0); if (devidoEvento > 0) { const diferenca = devidoEvento - recebidoEvento; const valorAtualizado = diferenca * (1 + indiceInfo.correcao + indiceInfo.juros); totais.devido += devidoEvento; totais.recebido += recebidoEvento; totais.diferenca += diferenca; totais.atualizado += valorAtualizado; bodyHTML += `<tr class="border-b border-gray-200"><td class="py-2 px-3">${leiAplicada}</td><td class="py-2 px-3">${evento}</td><td class="py-2 px-3">${mesRef}</td><td class="py-2 px-3">${periodo.nivel}</td><td class="py-2 px-3 text-right">${formatToCurrency(devidoEvento)}</td><td class="py-2 px-3 text-right">${formatToCurrency(recebidoEvento)}</td><td class="py-2 px-3 text-right font-medium ${diferenca > 0 ? 'text-red-600' : 'text-green-600'}">${formatToCurrency(diferenca)}</td><td class="py-2 px-3 text-right font-bold">${formatToCurrency(valorAtualizado)}</td><td class="py-2 px-3 text-right">${((indiceInfo.juros + indiceInfo.correcao) * 100).toFixed(2)}%</td><td class="py-2 px-3 text-right">${indiceInfo.nome}</td><td class="py-2 px-3 text-center space-x-2 no-print"><button onclick="addRowManual(this)" class="text-green-600 hover:text-green-800"><i class="fas fa-plus-circle"></i></button><button onclick="removeRow(this)" class="text-red-600 hover:text-red-800"><i class="fas fa-minus-circle"></i></button></td></tr>`; } }); currentDate.setUTCMonth(currentDate.getUTCMonth() + 1); } }); return { html: createTableHTML(nome, bodyHTML, totais), totalRequerenteAtualizado: totais.atualizado }; }
            function createTableHTML(nome, bodyHTML, totais) { return `<div class="requerente-bloco" data-requerente-nome="${nome}"><h3 class="text-2xl font-semibold text-primary-blue mb-4 no-print">${nome}</h3><div class="overflow-x-auto rounded-lg shadow-lg"><table class="calculation-table w-full border-collapse table-auto"><thead><tr class="bg-gray-200 text-gray-700 uppercase text-xs leading-normal"><th class="py-3 px-4 text-left">Lei Aplicada</th><th class="py-3 px-4 text-left">Descrição</th><th class="py-3 px-4 text-left">Mês Ref.</th><th class="py-3 px-4 text-left">Nível/Classe</th><th class="py-3 px-4 text-right">Devido</th><th class="py-3 px-4 text-right">Recebido</th><th class="py-3 px-4 text-right">Diferença</th><th class="py-3 px-4 text-right">Valor Atualizado</th><th class="py-3 px-4 text-right">Juros(%)</th><th class="py-3 px-4 text-right">Índice</th><th class="py-3 px-4 text-center no-print">Ações</th></tr></thead><tbody class="bg-white text-gray-600 text-sm font-light divide-y divide-gray-200">${bodyHTML}</tbody><tfoot><tr class="bg-gray-50 text-gray-700 font-bold"><td class="py-3 px-4 text-right" colspan="4">Total (${nome})</td><td class="py-3 px-4 text-right">${formatToCurrency(totais.devido)}</td><td class="py-3 px-4 text-right">${formatToCurrency(totais.recebido)}</td><td class="py-3 px-4 text-right">${formatToCurrency(totais.diferenca)}</td><td class="py-3 px-4 text-right">${formatToCurrency(totais.atualizado)}</td><td class="py-3 px-4 text-right" colspan="3"></td></tr></tfoot></table></div></div>`; }
            function generateReport() { const container = document.getElementById('requerentes-tables-container'); if (container.children.length === 0) return alert("Calcule os valores antes de gerar um relatório."); const dataCitacaoVal = document.getElementById('dataCitacao').value; const dataCitacaoFmt = dataCitacaoVal ? new Date(dataCitacaoVal + 'T00:00:00').toLocaleDateString('pt-BR') : 'Não informada'; const header = document.createElement('div'); header.id = 'report-header'; header.className = 'mb-8 border-b pb-4'; header.innerHTML = `<h2 class="text-2xl font-bold">Relatório de Cálculo de Enquadramento</h2><p><strong>Processo:</strong> ${document.getElementById('processNumber').value}</p><p><strong>Requerentes:</strong> ${document.getElementById('requerentesInput').value}</p>`; container.prepend(header); container.querySelectorAll('.requerente-bloco').forEach(bloco => { const nome = bloco.dataset.requerenteNome; const config = requerenteConfigStorage[nome]; const enquadramentos = config.periodos.map(p => { const inicioFmt = p.inicio ? `${p.inicio.substring(5, 7)}/${p.inicio.substring(0, 4)}` : ''; const fimFmt = p.fim ? `${p.fim.substring(5, 7)}/${p.fim.substring(0, 4)}` : ''; return `${p.nivel} (${inicioFmt} a ${fimFmt})`; }).join(', '); const indicesUnicos = [...new Set(config.periodos.map(p => p.indice))].join(', '); const leisUnicas = [...new Set(config.periodos.map(p => getLeiParaNivel(p.nivel)))].join(', '); const resumo = document.createElement('div'); resumo.className = 'report-summary mt-6 p-4 bg-gray-50 rounded-lg border text-sm'; resumo.innerHTML = `<h5 class="font-bold mb-2">Resumo da Metodologia de Cálculo</h5><p>O cálculo para <strong>${nome}</strong> (matrícula ${config.dadosTurmalina.matricula || 'N/D'}) foi realizado com base na(s) lei(s) <strong>${leisUnicas}</strong>, para o cargo de <strong>${config.dadosTurmalina.cargo || 'N/D'}</strong>. O período de apuração total considerou os seguintes enquadramentos: <strong>${enquadramentos}</strong>.</p><p>Os valores recebidos foram obtidos via consulta simulada ao sistema <strong>Turmalina</strong>. A correção monetária foi aplicada com o(s) índice(s) <strong>${indicesUnicos}</strong>, calculada a partir da data de citação em <strong>${dataCitacaoFmt}</strong>.</p>`; bloco.appendChild(resumo); }); window.print(); }
            window.onafterprint = () => { document.getElementById('report-header')?.remove(); document.querySelectorAll('.report-summary').forEach(el => el.remove()); };

            // ====================================================================
            // FUNÇÕES DE VALIDAÇÃO E UTILITÁRIAS
            // ====================================================================
            window.saveParametersForRequerente = function () {
                const modal = document.getElementById('requerenteParamModal');
                const requerenteNome = modal.dataset.currentRequerente;
                
                // 1. Coletar todos os dados do formulário em um objeto temporário
                const tempConfig = {
                    isConfigured: false,
                    eventos: Array.from(modal.querySelectorAll('#eventos-container input:checked')).map(cb => cb.value),
                    dadosTurmalina: { ...requerenteConfigStorage[requerenteNome].dadosTurmalina, cargo: modal.querySelector('#cargoRequerente').value },
                    periodoGeral: { inicio: modal.querySelector('#turmalina-inicio').value, fim: modal.querySelector('#turmalina-fim').value },
                    periodos: Array.from(modal.querySelectorAll('.periodo-item')).map(item => ({
                        inicio: item.querySelector('input[name="periodo_inicio"]').value,
                        fim: item.querySelector('input[name="periodo_fim"]').value,
                        nivel: item.querySelector('select[name="periodo_nivel"]').value,
                        indice: item.querySelector('select[name="periodo_indice"]').value,
                    }))
                };

                // 2. Validar o objeto temporário
                const validation = validateParameters(tempConfig);
                if (!validation.isValid) {
                    alert(`Erro de Validação: ${validation.message}`);
                    return;
                }

                // 3. Se for válido, salvar os dados formatados no storage principal
                const finalConfig = requerenteConfigStorage[requerenteNome];
                finalConfig.isConfigured = true;
                finalConfig.eventos = tempConfig.eventos;
                finalConfig.dadosTurmalina = tempConfig.dadosTurmalina;
                finalConfig.periodoGeral = { inicio: formatToYYYYMM(tempConfig.periodoGeral.inicio), fim: formatToYYYYMM(tempConfig.periodoGeral.fim) };
                finalConfig.periodos = tempConfig.periodos.map(p => ({ ...p, inicio: formatToYYYYMM(p.inicio), fim: formatToYYYYMM(p.fim) }));
                
                alert(`Parâmetros para ${requerenteNome} foram salvos com sucesso!`);
                closeModal('requerenteParamModal');
                populateRequerentesParams(); // Atualiza a lista principal em tempo real
            };
            
            function validateParameters(config) {
                if (!config.periodoGeral.inicio || !config.periodoGeral.fim) return { isValid: false, message: "O Período Geral (Início e Fim) na seção Turmalina deve ser preenchido." };
                if (config.periodos.length === 0) return { isValid: false, message: "Adicione pelo menos um Sub-Período de Cálculo." };

                for (let i = 0; i < config.periodos.length; i++) {
                    const p = config.periodos[i];
                    if (!p.inicio || !p.fim || !p.nivel || !p.indice) return { isValid: false, message: `O Sub-Período #${i + 1} está incompleto. Preencha todos os campos.` };
                }

                const periodoGeralStartStr = config.periodoGeral.inicio;
                const periodoGeralEndStr = config.periodoGeral.fim;
                const firstSubPeriodStartStr = config.periodos[0].inicio;
                const lastSubPeriodEndStr = config.periodos[config.periodos.length - 1].fim;

                if (periodoGeralStartStr !== firstSubPeriodStartStr) return { isValid: false, message: "O início do primeiro Sub-Período não corresponde ao início do Período Geral." };
                if (periodoGeralEndStr !== lastSubPeriodEndStr) return { isValid: false, message: "O fim do último Sub-Período não corresponde ao fim do Período Geral." };

                for (let i = 0; i < config.periodos.length - 1; i++) {
                    const currentEndStr = config.periodos[i].fim;
                    const nextStartStr = config.periodos[i + 1].inicio;
                    if (getNextMonth(currentEndStr) !== nextStartStr) return { isValid: false, message: `Há uma falha ou sobreposição na linha do tempo entre o Sub-Período #${i + 1} e #${i + 2}. Os períodos devem ser contínuos.` };
                }
                
                return { isValid: true, message: "Configuração válida." };
            }

            function applyDateMask(event) { let input = event.target; let value = input.value.replace(/\D/g, ''); if (value.length > 2) value = `${value.substring(0, 2)}/${value.substring(2, 6)}`; input.value = value; }
            function parseMaskedDate(maskedDate) { if (!maskedDate || maskedDate.length < 7) return null; const [month, year] = maskedDate.split('/'); return new Date(year, month - 1, 1); }
            function formatToYYYYMM(maskedDate) { if (!maskedDate || maskedDate.length < 7) return ''; const [month, year] = maskedDate.split('/'); return `${year}-${month.padStart(2, '0')}`; }
            function formatToMMYYYY(yyyyMM) { if (!yyyyMM || yyyyMM.length < 7) return ''; const [year, month] = yyyyMM.split('-'); return `${month}/${year}`; }
            function getNextMonth(maskedDate) { if (!maskedDate || maskedDate.length < 7) return ''; const date = parseMaskedDate(maskedDate); date.setMonth(date.getMonth() + 1); const nextMonth = (date.getMonth() + 1).toString().padStart(2, '0'); const nextYear = date.getFullYear(); return `${nextMonth}/${nextYear}`; }
            function updateTaxRate(event) { const row = event.target.closest('.periodo-item'); const indiceSelect = row.querySelector('select[name="periodo_indice"]'); const fimInput = row.querySelector('input[name="periodo_fim"]'); const taxaInput = row.querySelector('input[name="periodo_taxa"]'); const dataCitacao = document.getElementById('dataCitacao').value; const indiceName = indiceSelect.value; if (!indiceName) { taxaInput.value = ''; taxaInput.placeholder = '-'; return; } if (indiceName.includes('SELIC')) { taxaInput.value = 'N/A'; return; } const indiceInfo = mockIndices[indiceName]; const jurosMensal = indiceInfo?.juros || 0; taxaInput.value = (jurosMensal * 100).toFixed(2) + '% a.m.'; if (dataCitacao && fimInput.value && fimInput.value.length >= 7) { const startDate = new Date(dataCitacao); const endDate = parseMaskedDate(fimInput.value); if (endDate && !isNaN(startDate) && !isNaN(endDate) && endDate >= startDate) { const mesesDeAtraso = (endDate.getFullYear() - startDate.getFullYear()) * 12 + (endDate.getMonth() - startDate.getMonth()); if (mesesDeAtraso >= 0) taxaInput.value = (mesesDeAtraso * jurosMensal * 100).toFixed(2) + '% Total'; } } }
            window.formatToCurrency = (v) => (Number(v) || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            window.parseCurrency = (v) => typeof v !== 'string' ? (Number(v) || 0) : (Number(v.replace(/R\$\s?/, '').replace(/\./g, '').replace(',', '.')) || 0);
            window.removeRow = (btn) => btn.closest('tr').remove();
            window.addRowManual = (btn) => { const row = btn.closest('tr'); const clone = row.cloneNode(true); row.parentNode.insertBefore(clone, row.nextSibling); };
            function getLeiParaNivel(nivel) { for (const lei in mockSalarioTabela) if (mockSalarioTabela[lei][nivel]) return lei; return 'Lei não encontrada'; }
            function countMonths(start, end) { if (!start || !end) return 0; const s = new Date(start), e = new Date(end); return (e.getFullYear() - s.getFullYear()) * 12 + (e.getMonth() - s.getMonth()) + 1; }
            window.saveCalculation = () => alert('Funcionalidade "Salvar Cálculo" em desenvolvimento.');
            window.clearForm = () => { if(confirm("Tem certeza?")) { document.getElementById('formFields').querySelectorAll('input, select').forEach(el => el.value = ''); document.getElementById('requerentes-tables-container').innerHTML = ''; document.getElementById('valorExecutadoSummary').textContent = 'R$ 0,00'; document.getElementById('valorAtualizadoSummary').textContent = 'R$ 0,00'; document.getElementById('proveitoEconomicoSummary').textContent = 'R$ 0,00'; requerenteConfigStorage = {}; } };
        </script>
        <script>
            tailwind.config = {
                theme: { extend: { fontFamily: { sans: ['Inter', 'sans-serif'] }, colors: { 'primary-blue': '#143968', 'primary-teal': '#14d2aa', 'secondary-teal': '#0fb395', 'secondary-blue': '#063db3', } }, },
            };
        </script>
</body>
</html>